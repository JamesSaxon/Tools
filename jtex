#!/usr/bin/python
# -*- coding: utf-8 -*-

import sys
import os
import string
import re

graphs = ["eps", "pdf", "png", "jpg"]

FORMAT = None
TYPES = { 
           "equation"         : [  1, "$",    "\[ %s \]"], 
           "numequation"      : [  2, "#$",   "\\begin{equation}  %s \n\end{equation}"],
           "boxed"            : [  3, "!",    "\[ \\boxed{ %s } \]"],
           "subsubsectionstar": [  4, ">>>*", "\subsubsection*{%s}"],
           "subsectionstar"   : [  5, ">>*",  "\subsection*{%s}"],
           "sectionstar"      : [  6, ">*",   "\section*{%s}"],
           "subsubsubsection" : [  7, ">>>>", "\\vspace{0.5em}\\noindent\emph{%s}"],
           "subsubsection"    : [  8, ">>>",  "\subsubsection{%s}"],
           "subsection"       : [  9, ">>",   "\subsection{%s}"],
           "section"          : [ 10, ">",    "\section{%s}"],
           "subsubsubitem"    : [ 11, "----", "\\begin{itemize}\n\\begin{itemize}\n\\begin{itemize}\n\\begin{itemize}\n    \item  %s \n\end{itemize}\n\end{itemize}\n\end{itemize}\n\end{itemize}"],
           "subsubitem"       : [ 12, "---",  "\\begin{itemize}\n\\begin{itemize}\n\\begin{itemize}\n   \item  %s \n\end{itemize}\n\end{itemize}\n\end{itemize}"],
           "subitemenum"      : [ 13, "--#",  "\\begin{itemize}\n\\begin{itemize}\n\\begin{enumerate}\n   \item  %s \n\end{enumerate}\n\end{itemize}\n\end{itemize}"],
           "subitem"          : [ 14, "--",   "\\begin{itemize}\n\\begin{itemize}\n  \item  %s \n\end{itemize}\n\end{itemize}"],
           "subenumitem"      : [ 15, "-#-",  "\\begin{itemize}\n\\begin{enumerate}\n\\begin{itemize} \item  %s \end{itemize}\n\end{enumerate}\n\end{itemize}"],
           "itemenum"         : [ 16, "-#",   "\\begin{itemize}\n\\begin{enumerate}\n \item  %s \end{enumerate}\n\end{itemize}"],
           "item"             : [ 17, "-",    "\\begin{itemize}\n\item  %s \n\end{itemize}"],
           "numalign"         : [ 18, "#@",   "\\begin{align}\n %s \end{align}"],
           "enumii"           : [ 19, "#--",  "\\begin{enumerate}\n\\begin{itemize}\n\\begin{itemize}\n \item  %s \n\end{itemize}\n\end{itemize}\n\end{enumerate}"],
           "enumi"            : [ 20, "#-",   "\\begin{enumerate}\n\\begin{itemize}\n \item  %s \n\end{itemize}\n\end{enumerate}"],
           "enum"             : [ 21, "#",   "\\begin{enumerate}\n\item  %s \n\end{enumerate}"],
           "align"            : [ 22, "@",   "\\begin{align*}\n %s \end{align*}"]
        }


appendix = False

prologue= """\documentclass[%d pt]{%s}
\usepackage[top=%.2fin,bottom=%.2fin,left=%.2fin,right=%.2fin]{geometry}

\input{js_header.tex}

%% Header from jtex file.
%s 

\hypersetup{
  colorlinks=true,linkcolor=blue,citecolor=blue,urlcolor=blue,
  pdftitle={%s}, pdfauthor={%s}
  pdfpagemode={UseOutlines},
  bookmarksopen=true, bookmarksnumbered=true,
  pdfstartview={Fit}
}

\\title[%s]{%s}
\date{\\today}
\\author[%s]{\\vspace{-1.7em} %s}
%s
%s

\\begin{document}

%s

"""

epilogue = "\n\n\end{document}\n\n"


parDict = {
  ")": "\\right) ", 
  "(": "\left( ", 
  "]": "\\right] ", 
  "[": "\left[ ", 
  "{": "left\{ ", 
  "}": "right\} "
}

symDict = {
  "¬Ω".decode('utf-8'): "\half ", 
  "¬º".decode('utf-8'): "1/4 ",
  "‚Ñö".decode('utf-8'): "\mathbb{Q} ", 
  "‚Ñ§".decode('utf-8'): "\mathbb{Z} ", 
  "√ó".decode('utf-8'): "\\times ", 
  "‚â•".decode('utf-8'): "\geq ", 
  "‚â§".decode('utf-8'): "\leq ", 
  "‚Üí".decode('utf-8'): "\\rightarrow ", 
  "‚áí".decode('utf-8'): "\Thus ", 
  "‚à´".decode('utf-8'): "\int ", 
  "‚àÆ".decode('utf-8'): "\oint ", 
  "¬∑".decode('utf-8'): "\cdot ", 
  "¬±".decode('utf-8'): "\pm ", 
  "‚àì".decode('utf-8'): "\mp ", 
  "‚úî".decode('utf-8'): "\checkmark ", 
  "‚âà".decode('utf-8'): "\\approx ", 
  "‚â°".decode('utf-8'): "\equiv ", 
  "‚àù".decode('utf-8'): "\propto ", 
  "‚àà".decode('utf-8'): "\,\in\, ", 
  "‚â†".decode('utf-8'): "\\neq ", 
  "‚àû".decode('utf-8'): "\infty ", 
  "‚àö".decode('utf-8'): "\sqrt ", 
  "ƒß".decode('utf-8'): "\hbar ", 
  "‚àá".decode('utf-8'): "\\nabla ", 
  "…Ü".decode('utf-8'): "\slashed{E} ", 
  "‚Ñã".decode('utf-8'): "\mathcal{H} ", 
  "‚Ñí".decode('utf-8'): "\mathcal{L} ", 
  "ùí™".decode('utf-8'): "\mathcal{O} ", 
  "‚àÇ".decode('utf-8'): "\partial ", 
  "‚Ñì".decode('utf-8'): "\ell ",
  "√∑".decode('utf-8'): "\\frac",
  "‚ò∫".decode('utf-8'): "\smiley{}",
  "‚ïë".decode('utf-8'): "\parallel",
  "‚î¥".decode('utf-8'): "\\bot",
  "¬°".decode('utf-8'): "\\text{<}",
  "¬ø".decode('utf-8'): "\\text{>}",
  "‚ñ°".decode('utf-8'): "\pie{0}{red}",
  "¬ß".decode('utf-8'): "\S",
  "‚Äò".decode('utf-8'): "`", 
  "‚Äô".decode('utf-8'): "'",  
  "‚Äú".decode('utf-8'): "``", 
  "‚Äù".decode('utf-8'): "''", 
  "‚Ä≤".decode('utf-8'): "'",
  "‚Äî".decode('utf-8'): "--", 
  "‚Äì".decode('utf-8'): "--",
  " Ùè∞ù".decode('utf-8'): " ",
  u'\xa0': " ",
  "‚Ä¶".decode('utf-8'): "\ldots{}",
  "‚Ç¨".decode('utf-8'): "E",
  "¬Æ".decode('utf-8'): "\ensuremath{\circledR}",
}

grDict = {
  "Œ±".decode('utf-8'): "\\alpha ",
  "Œ≤".decode('utf-8'): "\\beta ",
  "œà".decode('utf-8'): "\psi ",
  "Œ¥".decode('utf-8'): "\delta ",
  "Œµ".decode('utf-8'): "\\varepsilon ",
  "œµ".decode('utf-8'): "\\varepsilon ",
  "œÜ".decode('utf-8'): "\\varphi ",
  "Œ≥".decode('utf-8'): "\gamma ",
  "Œ∑".decode('utf-8'): "\eta ",
  "Œπ".decode('utf-8'): "\iota ",
  "Œæ".decode('utf-8'): "\\xi ",
  "Œ∫".decode('utf-8'): "\kappa ",
  "Œª".decode('utf-8'): "\lambda ",
  "Œº".decode('utf-8'): "\mu ",
  "¬µ".decode('utf-8'): "\mu ",
  "ŒΩ".decode('utf-8'): "\\nu ",
  "Œø".decode('utf-8'): "\omicron ",
  "œÄ".decode('utf-8'): "\pi ",
  "œÅ".decode('utf-8'): "\\rho ",
  "œÉ".decode('utf-8'): "\sigma ",
  "œÑ".decode('utf-8'): "\\tau ",
  "Œ∏".decode('utf-8'): "\\theta ",
  "œâ".decode('utf-8'): "\omega ",
  "œá".decode('utf-8'): "\chi ",
  "œÖ".decode('utf-8'): "\upsilon ",
  "Œ∂".decode('utf-8'): "\zeta ",
  "Œë".decode('utf-8'): "\Alpha ",
  "Œí".decode('utf-8'): "\Beta ",
  "Œ®".decode('utf-8'): "\Psi ",
  "Œî".decode('utf-8'): "\Delta ",
  "Œï".decode('utf-8'): "\Epsilon ",
  "Œ¶".decode('utf-8'): "\Phi ",
  "Œì".decode('utf-8'): "\Gamma ",
  "Œó".decode('utf-8'): "\Eta ",
  "Œô".decode('utf-8'): "\Iota ",
  "Œû".decode('utf-8'): "\Xi ",
  "Œö".decode('utf-8'): "\Kappa ",
  "Œõ".decode('utf-8'): "\Lambda ",
  "Œú".decode('utf-8'): "\Mu ",
  "Œù".decode('utf-8'): "\Nu ",
  "Œü".decode('utf-8'): "\Omicron ",
  "Œ†".decode('utf-8'): "\prod ",
  "Œ°".decode('utf-8'): "\Rho ",
  "Œ£".decode('utf-8'): "\sum ",
  "Œ§".decode('utf-8'): "\Tau ",
  "Œò".decode('utf-8'): "\Theta ",
  "Œ©".decode('utf-8'): "\Omega ",
  "Œß".decode('utf-8'): "\Chi ",
  "Œ•".decode('utf-8'): "\Upsilon ",
  "Œñ".decode('utf-8'): "\Zeta "
}

supDict = {
  "¬π".decode('utf-8'): "^1 ",
  "¬≤".decode('utf-8'): "^2 ",
  "¬≥".decode('utf-8'): "^3 ",
  "‚Å¥".decode('utf-8'): "^4 ",
  "‚Åµ".decode('utf-8'): "^5 ",
  "‚Å∂".decode('utf-8'): "^6 ",
  "‚Å∑".decode('utf-8'): "^7 ",
  "‚Å∏".decode('utf-8'): "^8 ",
  "‚Åπ".decode('utf-8'): "^9 ",
  "‚Å∞".decode('utf-8'): "^0 ",
  "‚úù".decode('utf-8'): "^\dagger ",
  #"*".decode('utf-8'): "^\star ",
  "‚Å∫".decode('utf-8'): "^+ ",
  "‚Åª".decode('utf-8'): "^- "
}

subDict = {
  "‚ÇÅ".decode('utf-8'): "_1 ",
  "‚ÇÇ".decode('utf-8'): "_2 ",
  "‚ÇÉ".decode('utf-8'): "_3 ",
  "‚ÇÑ".decode('utf-8'): "_4 ",
  "‚ÇÖ".decode('utf-8'): "_5 ",
  "‚ÇÜ".decode('utf-8'): "_6 ",
  "‚Çá".decode('utf-8'): "_7 ",
  "‚Çà".decode('utf-8'): "_8 ",
  "‚Çâ".decode('utf-8'): "_9 ",
  "‚ÇÄ".decode('utf-8'): "_0 ",
  "·µÄ".decode('utf-8'): "_T ",
  "·µ¢".decode('utf-8'): "_i ",
  "‚±º".decode('utf-8'): "_j ",
  "·µ£".decode('utf-8'): "_r ",
}

accDict = {
  "√°".decode('utf-8'): "\\'a",
  "√≥".decode('utf-8'): "\\'o",
  "√§".decode('utf-8'): "\\\"a",
  "√Ø".decode('utf-8'): "\\\"i",
  "√∂".decode('utf-8'): "\\\"o",
  "√º".decode('utf-8'): "\\\"u",
  "√†".decode('utf-8'): "\`a",
  "√©".decode('utf-8'): "\\'e",
  "√®".decode('utf-8'): "\`e",
  "AÃä".decode('utf-8'): "\AA",
  "Ô¨Ä".decode('utf-8'): "ff",
  "Ô¨Å".decode('utf-8'): "fi",
}

modDict = {
  u"\u20D7": "\\bm",
  u"\u0305": "\\overline",
  u"\u0307": "\dot",
  # u"\u0308": "\ddot",
  u"\u0308": "\\\" ",
  u"\u0338": "\slashed",
  u"\u0303": "\\tilde",
  u"\u0302": "\\hat",
  u"\u030a": ""
}

########################################
####  IS IT AN EQUATION, ETC.  #########
def GetSpecialFormat(line):

  decline = line.decode('utf-8')[0:-1]

  global FORMAT
  FORMAT = None

  t = TYPES.items()
  t.sort(key=lambda a: a[1][0])

  for key, val in t:

    if decline[0:len(val[1])] == val[1]:
      FORMAT = key
      decline = decline[len(val[1]):]
      break

  return decline

#########################################################
#########################################################

def ProcessFigure(line):

  figure = ""
  figCaption = []
  graphics, widths, subCaption, subLabel = [], [], [], []

  opt = ""
  if line[0] == "[":
    opt = line.split()[0][1:-1]
    line = line[line.find("]")+1:]

  # potential subfigures are split by ";"
  pieces = line.split(";")
  for p in pieces:

    # if there's a figure in this piece...
    if max([p.find("." + gri) for gri in graphs]) != -1:
      # worry about making subfigures.
      subCaption.append(" ")
      subLabel.append(" ")
      for word in p.split():
        pos = [word.find("." + graphs[i]) for i in range(len(graphs))]
        if max(pos) != -1:
          if word.find(":") != -1: 
            graphics.append(word[0:word.find(":")])
            widths.append(float(word[word.find(":")+1:]))
          else:
            graphics.append(word)
            widths.append(1.01)
        elif "label" in word:
          subLabel[-1] = word
        else:
          subCaption[-1] += word + " "
    elif p.strip is not "": # just add it to the figure caption.
      figCaption.append(p)
  figure = "\\begin{figure}[%s]" % opt
  if appendix:
    figure += "[h]"
  figure += "\n\centering\n"      
  if len(graphics) == 1:
    w = 0.45 if widths[0] == 1.01 else widths[0]
    figure += "\includegraphics[width=" + str(w) + "\\textwidth]{" + graphics[0] + "}\n"
    if (subCaption[0] + subLabel[0]).strip() is not "":
      figCaption.append(subCaption[0] + subLabel[0])
  else:
    linewidth = 0.
    for i, g in enumerate(graphics):
      w = 0.47
      if widths[i] != 1.01:
        w = widths[i]
      if (linewidth + w) > 1.02:
        figure += "\\\\ \n"
        linewidth = 0
      linewidth += w

      figure += "\subfloat"
      if len(ToTeX(subCaption[i]).strip()):
        figure += "[" + ToTeX(subCaption[i]) + "]"
      figure += "{\includegraphics[width=" + str(w) + "\\textwidth]{" + g + "}" + subLabel[i].strip() + "}"
      figure += "\n"

  if len(figCaption) == 1:
    figure += "\caption{" + ToTeX(figCaption[0]) + "}\n"
  elif len(figCaption) > 1:
    figure += "\caption[%s]{%s}\n" % (ToTeX(figCaption[0]), ToTeX(figCaption[1]))
  figure += "\end{figure}\n\n"

  return figure

#########################################################
#########################################################

def CleanDocument(doc):

  ret = ""

  for c in doc:
    try:
      ret += c.encode('ascii')
    except UnicodeEncodeError:
      
      print "Could not encode character %s" % repr(c)[3:-1]
      ret += " "

  return ret

#########################################################
#########################################################

def ToTeX(line):

  line = ModifierReplacement(line)
  line = FixParentheses(line)
  line = SubsAndSupers(line)
  line = SymbolReplacement(line)
  return line.strip()

#########################################################
#########################################################

# Modifiers are a bit funny -- we need to swap the order.
def ModifierReplacement(line):

  for m, v in modDict.iteritems():
    while m in line:
      pos = line.find(m)
      line = line[0:pos-1] + modDict[line[pos]] + " " + line[pos-1] + line[pos+1:]

  return line

# Get the parenthesis out of the way -- they'll mess up the sub/supers.
def FixParentheses(line):

  temp = ""
  for i in range(len(line)):
    if line[i] not in parDict or \
      (FORMAT not in ["equation", "numequation", "boxed", "align", "numalign"] and (line[:i].count("$") % 2) == 0) or \
      (line[i] in ["}", "{"] and line[i-1] != "\\") or \
      ("big" in temp[-4:].lower()):
      temp += line[i]
    elif line[i] in [")", "("] and line[i-1] == "\\":
      temp = temp[:-1] + line[i]
    else:
      temp += parDict[line[i]]

  return temp


#########################################################
#########################################################

def SubsAndSupers(line):

  line += " "
  i = 0
  while i < len(line):
    count = 0
    if line[i] in supDict:
      count = 1
      temp = supDict[line[i]]
      while line[i+count] in supDict:
        temp += supDict[line[i+count]]
        count += 1
      temp = "^{" + temp.replace("^", "") + "} "
      line = line[0:i] + temp + line[i+count:]
    i += 1 + 2 * count
      
  i = 0
  while i < len(line):
    count = 1
    if line[i] in subDict:
      temp = subDict[line[i]]
      while line[i+count] in subDict:
        temp += subDict[line[i+count]]
        count += 1
      temp = "_{" + temp.replace("_", "") + "} "
      line = line[0:i] + temp + line[i+count:]
    i += count

  return line

#########################################################
#########################################################

def SymbolReplacement(line):

  texline = ""

  for i in range(len(line)):
    if line[i] in accDict:
      texline += accDict[line[i]]
    elif line[i] in grDict:
      texline += grDict[line[i]]
    elif line[i] in symDict:
      texline += symDict[line[i]]
    else:
      texline += line[i]

  return texline

#########################################################
#########################################################

def GetHeader(input):

  title = ""
  short_title = ""
  author = "James Saxon"
  institute = "Center for Data and Computing, University of Chicago"
  email = "jsaxon@uchicago.edu"
  short_author = "Saxon"
  abstract = ""
  docclass = "amsart"
  TITLE = True
  font = 11
  mT, mB, mL, mR = [1. for i in range(4)]
  header = ""

  for line in open(input):

    if line[0] is not "^":
      break

    if line[:3] == "^NT":
      TITLE = False
    if line[:3] == "^T:":
      title = ToTeX(line[3:].decode('utf-8'))
    if line[:4] == "^ST:":
      short_title = ToTeX(line[4:].decode('utf-8'))
    if line[:3] == "^A:":
      author = ToTeX(line[3:].decode('utf-8'))
    if line[:3] == "^I:":
      institute = ToTeX(line[3:].decode('utf-8'))
    if line[:3] == "^E:":
      email = line[3:].decode('utf-8').strip()
    if line[:4] == "^SA:":
      short_author = ToTeX(line[4:].decode('utf-8'))
    if line[:4] == "^AB:":
      abstract += ToTeX(line[4:].strip().decode('utf-8')) + "\n\n"
    if line[:3] == "^C:":
      docclass = line[3:].strip()
    if line[:3] == "^G:":
      geo = line[3:].strip().split()
      if len(geo) == 4:
        mT, mB, mL, mR = [float(g) for g in geo]
      elif len(geo) == 2:
        mT, mB = float(geo[0]), float(geo[0])
        mL, mR = float(geo[1]), float(geo[1])
      else:
        mT, mB, mL, mR = [float(geo[0]) for i in range(4)]
    if line[:3] == "^F:":
      font = int(line[3:].strip())
    if line[:3] == "^H:":
      header += line[3:].strip() + "\n"

  if short_title == "":
    short_title = title

  if short_author == "":
    short_author = author

  if abstract:
    abstract = "\\begin{abstract}\n" + abstract + "\n\end{abstract}\n"

  if institute: institute = "\\address{%s \\vspace{0.5em}}" % institute
  if email: email = "\\email{%s}" % email 

  header = prologue % (font, docclass, mT, mB, mL, mR, header, title, author, short_title, title, short_author, author, email, institute, abstract)
  if TITLE: header += "\n\\vspace{-1em}\maketitle\n\n"

  return header



#########################################################
#########################################################



def main(input, output, header, pdflatex):

  file = open(input)

  if header: header = GetHeader(input)

  document = ""

  for line in open(input):

    if line[0] == "^": continue
  
    if line == "\n":
      document += "\n"
      continue

    decline = GetSpecialFormat(line)

    # Graphics are tricky... they get pulled out.
    if max([decline.find("." + g) for g in graphs]) != -1 \
       and "href" not in decline:
      document += ProcessFigure(decline)
      continue

    if "appendix" in line: appendix = True

    texline = ToTeX(decline)

    if FORMAT: texline = TYPES[FORMAT][2] % texline.strip()

    document += texline + "\n"

  file.close()

  document = CleanDocument(document)

  while "\end{itemize}\n\\begin{itemize}\n" in document or \
        "\end{enumerate}\n\\begin{enumerate}\n" in document:
    document = string.replace(document, "\end{itemize}\n\\begin{itemize}\n", "")
    document = string.replace(document, "\end{enumerate}\n\\begin{enumerate}\n", "")

  document = string.replace(document, "\end{align*}\n\\begin{align*}\n", " \\\\\n")
  document = string.replace(document, "\end{align}\n\\begin{align}\n", " \\\\\n")
  document = string.replace(document, "\end{equation}\n\\begin{equation}\n", " \\\\\n")

  if header: document = header + document + epilogue

  ofile = open(output, "w")

  if "\\begin{itemize}\n\\begin{itemize}\n" in document:
    idx = document.find("\\begin{itemize}\n\\begin{itemize}\n")
    print "double indent at ::", document[idx+30:idx+80]
    sys.exit()

  try:
    ofile.write(document)
  except UnicodeEncodeError as err:
    err_int = int(list(err)[-2])
    print output, "UnicodeEncodeError ::", repr(document[err_int-20:err_int+20])
    # print document[err_int-20:err_int+20].encode('ascii')
    sys.exit()

  ofile.close()

  if pdflatex: os.system('pdflatex ' + output)
  


#----------------------------------------------------
if __name__ == "__main__":

  from optparse import OptionParser

  p = OptionParser()
  p.add_option('-i', '--inputFile',  type = 'string', default = "", help = 'input File' )
  p.add_option('-o', '--outputFile', type = 'string', default = "", help = 'output File' )
  p.add_option('-d', '--header',     action = "store_true", default = False, help = 'default header and footer' )
  p.add_option('-p', '--pdflatex',   action = "store_true", default = False, help = 'run latex on the output' )

  (options,args) = p.parse_args()

  if options.inputFile == "":
    print "gotta give me a file!!"
    sys.exit()

  if options.outputFile == "":
    options.outputFile = options.inputFile + ".tex"

  main(options.inputFile, options.outputFile, options.header, options.pdflatex)


